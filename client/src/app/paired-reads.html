<div class="container-fluid" ng-controller="PairedReadsController" ng-init="init()">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-dna me-2"></i>
                Paired Reads Manager
            </h2>
            
            <!-- History Selection -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Select History</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <select class="form-select" ng-model="selectedHistory" ng-options="history as history.name for history in histories">
                                <option value="">-- Select a history --</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" ng-click="detectPairedReads()" 
                                    ng-disabled="!selectedHistory || isLoading">
                                <i class="fas fa-search me-2"></i>
                                <span ng-if="!isLoading">Detect Paired Reads</span>
                                <span ng-if="isLoading">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Detecting...
                                </span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-success me-2" ng-click="autoPairAllReads()" 
                                    ng-disabled="!selectedHistory || autoPairing">
                                <i class="fas fa-magic me-2"></i>
                                <span ng-if="!autoPairing">Auto-Pair All Reads</span>
                                <span ng-if="autoPairing">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Auto-Pairing...
                                </span>
                            </button>
                            <small class="text-muted ms-2">
                                Automatically detects pairs and creates Galaxy collections
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div ng-if="progress" class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>{{progress.stage}}</span>
                        <span>{{Math.round(progress.current)}}%</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             style="width: {{progress.current}}%">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Supported Patterns -->
            <div class="card mb-4" ng-if="supportedPatterns.length > 0">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Supported Paired Read Patterns
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>File Extensions</h6>
                            <div class="badge bg-secondary me-1 mb-1" ng-repeat="ext in supportedExtensions">
                                {{ext}}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Pairing Patterns</h6>
                            <div class="small" ng-repeat="pattern in supportedPatterns | limitTo:5">
                                <code>{{pattern.pattern}}</code> → 
                                <code>{{pattern.replacement}}</code>
                            </div>
                            <div class="text-muted mt-2" ng-if="supportedPatterns.length > 5">
                                And {{supportedPatterns.length - 5}} more patterns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Filters and Search -->
            <div ng-if="pairedReads && pairedReads.success && pairedReads.paired_groups.length > 0" class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Filters & Search</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <label class="form-label">Confidence</label>
                            <select class="form-select" ng-model="filters.confidence">
                                <option value="all">All Levels</option>
                                <option value="high">High (≥70%)</option>
                                <option value="medium">Medium (60-69%)</option>
                                <option value="low">Low (<60%)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Pair Type</label>
                            <select class="form-select" ng-model="filters.pairType">
                                <option value="all">All Types</option>
                                <option value="illumina_r1_r2">Illumina R1/R2</option>
                                <option value="illumina_1_2">Illumina 1/2</option>
                                <option value="forward_reverse">Forward/Reverse</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Collection Status</label>
                            <select class="form-select" ng-model="filters.collectionStatus">
                                <option value="all">All Status</option>
                                <option value="created">Created</option>
                                <option value="uncreated">Not Created</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Search</label>
                            <div class="input-group">
                                <input type="text" class="form-control" ng-model="filters.searchTerm" 
                                       placeholder="Search names...">
                                <button class="btn btn-outline-secondary" ng-click="filters.searchTerm = ''">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <label class="form-check">
                                        <input class="form-check-input" type="checkbox" ng-model="selectAll" ng-change="toggleSelectAll()">
                                        <span class="form-check-label">Select All ({{getFilteredPairs().length}})</span>
                                    </label>
                                </div>
                                <div>
                                    <button class="btn btn-outline-primary btn-sm me-2" ng-click="exportResults()">
                                        <i class="fas fa-download me-1"></i>
                                        Export Results
                                    </button>
                                    <button class="btn btn-primary btn-sm" ng-click="batchCreateCollections()" 
                                            ng-disabled="selectedPairs.length === 0 || batchCreating">
                                        <i class="fas fa-layer-group me-1"></i>
                                        <span ng-if="!batchCreating">Create Selected ({{selectedPairs.length}})</span>
                                        <span ng-if="batchCreating">
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                            Creating...
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Paired Reads Results -->
            <div ng-if="pairedReads && pairedReads.success">
                <!-- Summary -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Detection Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">{{pairedReads.total_pairs}}</div>
                                    <div class="stat-label">Paired Groups</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">{{pairedReads.total_unpaired}}</div>
                                    <div class="stat-label">Unpaired Files</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">
                                        {{(pairedReads.pairedGroups | filter:{confidence: '>=0.7'}).length}}
                                    </div>
                                    <div class="stat-label">High Confidence</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card">
                                    <div class="stat-number">
                                        {{(pairedReads.pairedGroups | filter:{collectionCreated: true}).length}}
                                    </div>
                                    <div class="stat-label">Collections Created</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Paired Groups -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">Detected Paired Groups</h5>
                        <span class="badge bg-primary">{{getFilteredPairs().length}} of {{pairedReads.pairedGroups.length}}</span>
                    </div>
                    <div class="card-body">
                        <div ng-if="getFilteredPairs().length === 0" class="text-center text-muted py-4">
                            <i class="fas fa-search fa-3x mb-3"></i>
                            <p>No paired groups match your filters</p>
                        </div>
                        
                        <div class="row" ng-repeat="group in getFilteredPairs()">
                            <div class="col-12 mb-3">
                                <div class="card" ng-class="{'border-success': group.confidence >= 0.7, 'border-warning': group.confidence < 0.7}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <div class="d-flex align-items-center">
                                            <input type="checkbox" class="form-check-input me-3" 
                                                   ng-model="selectedPairs" 
                                                   ng-change="togglePairSelection(group.group_id)"
                                                   ng-checked="selectedPairs.indexOf(group.group_id) !== -1">
                                            <div>
                                                <h6 class="mb-0">{{group.suggested_name}}</h6>
                                                <small class="text-muted">
                                                    {{getPairTypeDescription(group.pair_type)}} • 
                                                    Confidence: {{(group.confidence * 100).toFixed(1)}}%
                                                </small>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <span class="badge me-2" 
                                                  ng-class="{'bg-success': getConfidenceColor(group.confidence) === 'success', 
                                                           'bg-warning': getConfidenceColor(group.confidence) === 'warning',
                                                           'bg-danger': getConfidenceColor(group.confidence) === 'danger'}">
                                                {{(group.confidence * 100).toFixed(1)}}%
                                            </span>
                                            <button class="btn btn-sm btn-primary me-2" 
                                                    ng-click="createPairedCollection(group)"
                                                    ng-disabled="!canCreateCollection(group)"
                                                    ng-if="!group.collectionCreated">
                                                <i class="fas fa-plus me-1"></i>
                                                Create Collection
                                                <i class="fas fa-spinner fa-spin ms-1" ng-if="group.creating"></i>
                                            </button>
                                            <span class="badge bg-success me-2" ng-if="group.collectionCreated">
                                                <i class="fas fa-check me-1"></i>
                                                Collection Created
                                            </span>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6" ng-repeat="file in group.files">
                                                <div class="file-info">
                                                    <i class="fas fa-file me-2"></i>
                                                    <strong>{{file.name}}</strong>
                                                    <br>
                                                    <small class="text-muted">
                                                        {{formatFileSize(file.file_size)}} • 
                                                        {{file.data_type}}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Unpaired Files -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Unpaired Files</h5>
                    </div>
                    <div class="card-body">
                        <div ng-if="pairedReads.unpaired_files.length === 0" class="text-center text-muted py-4">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>All files were successfully paired!</p>
                        </div>
                        
                        <div class="row" ng-if="pairedReads.unpaired_files.length > 0">
                            <div class="col-md-4 mb-3" ng-repeat="file in pairedReads.unpaired_files">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{file.name}}</h6>
                                        <p class="card-text">
                                            <small class="text-muted">
                                                {{formatFileSize(file.file_size)}} • 
                                                {{file.data_type}}
                                            </small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div ng-if="isLoading" class="text-center py-5">
                <div class="skeleton-loader">
                    <div class="skeleton-card" ng-repeat="i in [1,2,3]">
                        <div class="skeleton-line"></div>
                        <div class="skeleton-line short"></div>
                        <div class="skeleton-line medium"></div>
                    </div>
                </div>
                <p class="mt-3">Detecting paired reads...</p>
            </div>
            
            <!-- No Results State -->
            <div ng-if="!pairedReads && !isLoading" class="text-center py-5">
                <i class="fas fa-dna fa-3x mb-3 text-muted"></i>
                <p class="text-muted">Select a history and click "Detect Paired Reads" to begin</p>
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    padding: 1rem;
    border-radius: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    text-align: center;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
}

.file-info {
    padding: 0.5rem;
    border-left: 3px solid #007bff;
    margin-bottom: 0.5rem;
    background-color: #f8f9fa;
    border-radius: 0.25rem;
}

.border-success {
    border-width: 2px !important;
}

.border-warning {
    border-width: 2px !important;
}

.skeleton-loader {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.skeleton-card {
    background: #f0f0f0;
    border-radius: 8px;
    padding: 1rem;
    height: 150px;
}

.skeleton-line {
    height: 12px;
    background: #e0e0e0;
    border-radius: 4px;
    margin-bottom: 0.5rem;
}

.skeleton-line.short { width: 60%; }
.skeleton-line.medium { width: 80%; }

@keyframes skeleton-loading {
    0% { background-position: -200px 0; }
    100% { background-position: calc(200px + 100%) 0; }
}

.skeleton-line {
    background: linear-gradient(
        90deg,
        #f0f0f0 0px,
        #e0e0e0 40px,
        #f0f0f0 80px
    );
    background-size: 200px 100%;
    animation: skeleton-loading 1.5s ease-in-out infinite;
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .stat-card {
        background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
    }
    
    .file-info {
        background-color: #374151;
        border-left-color: #60a5fa;
        color: #e2e8f0;
    }
    
    .skeleton-card {
        background: #4a5568;
    }
    
    .skeleton-line {
        background: linear-gradient(
            90deg,
            #4a5568 0px,
            #2d3748 40px,
            #4a5568 80px
        );
    }
}
</style>
