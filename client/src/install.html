<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Galaksio Setup</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <!-- Modern CSS -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="lib/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <link href="css/components.css" rel="stylesheet">
    <link href="css/responsive.css" rel="stylesheet">
    <link href="css/animations.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="install-page">
    <div class="install-container">
        <div class="row justify-content-center align-items-center min-vh-100">
            <div class="col-md-8 col-lg-6 col-xl-5">
                <div class="install-card">
                    <!-- Logo and Header -->
                    <div class="text-center mb-4">
                        <img src="css/galaxy_logo2.png" alt="Galaksio Logo" height="60" class="mb-3">
                        <h1 class="install-title">Welcome to Galaksio</h1>
                        <p class="install-subtitle">Setup your Galaxy workflow interface</p>
                    </div>
                    
                    <!-- Progress Indicator -->
                    <div class="progress-indicator mb-4">
                        <div class="progress-steps">
                            <div class="step active">
                                <div class="step-number">1</div>
                                <div class="step-label">Basic Config</div>
                            </div>
                            <div class="step">
                                <div class="step-number">2</div>
                                <div class="step-label">Galaxy Connection</div>
                            </div>
                            <div class="step">
                                <div class="step-number">3</div>
                                <div class="step-label">Admin Setup</div>
                            </div>
                            <div class="step">
                                <div class="step-number">4</div>
                                <div class="step-label">Complete</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 25%"></div>
                        </div>
                    </div>
                    
                    <!-- Installation Form -->
                    <form class="install-form" id="installForm">
                        <!-- Step 1: Basic Configuration -->
                        <div class="form-step active">
                            <h3 class="step-title">
                                <i class="fas fa-cogs me-2"></i> Basic Configuration
                            </h3>
                            
                            <div class="mb-3">
                                <label for="serverHost" class="form-label">Server Host</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-server"></i></span>
                                    <input type="text" class="form-control" id="serverHost" 
                                           placeholder="localhost" value="localhost" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid server host.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="serverPort" class="form-label">Server Port</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-port"></i></span>
                                    <input type="number" class="form-control" id="serverPort" 
                                           placeholder="8081" value="8081" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid port number.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="maxUpload" class="form-label">Max Upload Size (MB)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-upload"></i></span>
                                    <input type="number" class="form-control" id="maxUpload" 
                                           placeholder="500" value="500" required>
                                </div>
                                <div class="form-text">
                                    Maximum file upload size in megabytes
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid upload size.
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" disabled>
                                    <i class="fas fa-arrow-left me-1"></i> Previous
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 2: Galaxy Connection -->
                        <div class="form-step">
                            <h3 class="step-title">
                                <i class="fas fa-link me-2"></i> Galaxy Connection
                            </h3>
                            
                            <div class="mb-3">
                                <label for="galaxyServer" class="form-label">Galaxy Server URL</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-rocket"></i></span>
                                    <input type="url" class="form-control" id="galaxyServer" 
                                           placeholder="https://usegalaxy.eu" value="https://usegalaxy.eu" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid Galaxy server URL.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="galaxyApiKey" class="form-label">Galaxy API Key (Optional)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-key"></i></span>
                                    <input type="password" class="form-control" id="galaxyApiKey" 
                                           placeholder="Enter your Galaxy API key">
                                </div>
                                <div class="form-text">
                                    Leave empty if you want to configure this later
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="safeUpload" checked>
                                    <label class="form-check-label" for="safeUpload">
                                        Enable safe upload mode
                                    </label>
                                </div>
                                <div class="form-text">
                                    Validates files before uploading to Galaxy
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                    <i class="fas fa-arrow-left me-1"></i> Previous
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 3: Admin Setup -->
                        <div class="form-step">
                            <h3 class="step-title">
                                <i class="fas fa-user-shield me-2"></i> Admin Setup
                            </h3>
                            
                            <div class="mb-3">
                                <label for="adminEmail" class="form-label">Admin Email</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-envelope"></i></span>
                                    <input type="email" class="form-control" id="adminEmail" 
                                           placeholder="admin@example.com" required>
                                </div>
                                <div class="invalid-feedback">
                                    Please provide a valid email address.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="adminPassword" class="form-label">Admin Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="adminPassword" 
                                           placeholder="Enter password" required>
                                </div>
                                <div class="invalid-feedback">
                                    Password must be at least 6 characters long.
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="adminPasswordConfirm" class="form-label">Confirm Password</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-lock"></i></span>
                                    <input type="password" class="form-control" id="adminPasswordConfirm" 
                                           placeholder="Confirm password" required>
                                </div>
                                <div class="invalid-feedback">
                                    Passwords do not match.
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary" onclick="previousStep()">
                                    <i class="fas fa-arrow-left me-1"></i> Previous
                                </button>
                                <button type="button" class="btn btn-primary" onclick="nextStep()">
                                    Next <i class="fas fa-arrow-right ms-1"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Step 4: Complete -->
                        <div class="form-step">
                            <div class="text-center">
                                <div class="success-icon mb-3 animate-fade-in">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <h3 class="step-title animate-fade-in-up animate-delay-1">Installation Complete!</h3>
                                <p class="text-muted animate-fade-in-up animate-delay-2">
                                    Galaksio has been successfully configured and is ready to use.
                                </p>
                                
                                <div class="alert alert-success animate-fade-in-up animate-delay-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    You can now access Galaksio at: <strong>http://localhost:8081</strong>
                                </div>
                                
                                <button type="button" class="btn btn-success btn-lg animate-fade-in-up animate-delay-4" onclick="finishSetup()">
                                    <i class="fas fa-rocket me-1"></i> Launch Galaksio
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modern JavaScript -->
    <script src="lib/jquery/dist/jquery.min.js"></script>
    <script src="lib/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
        let currentStep = 0;
        const steps = document.querySelectorAll('.form-step');
        const stepIndicators = document.querySelectorAll('.progress-steps .step');
        
        function showStep(stepIndex) {
            // Hide all steps
            steps.forEach((step, index) => {
                step.classList.remove('active');
                if (index < stepIndex) {
                    step.style.display = 'none';
                } else if (index > stepIndex) {
                    step.style.display = 'none';
                } else {
                    step.style.display = 'block';
                }
            });
            
            // Update step indicators
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.toggle('active', index <= stepIndex);
            });
            
            // Update progress bar
            const progressFill = document.querySelector('.progress-fill');
            progressFill.style.width = `${((stepIndex + 1) / steps.length) * 100}%`;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function nextStep() {
            if (validateCurrentStep()) {
                currentStep = Math.min(currentStep + 1, steps.length - 1);
                showStep(currentStep);
            }
        }
        
        function previousStep() {
            currentStep = Math.max(currentStep - 1, 0);
            showStep(currentStep);
        }
        
        function validateCurrentStep() {
            const currentStepElement = steps[currentStep];
            const inputs = currentStepElement.querySelectorAll('input[required]');
            let isValid = true;
            
            // Validate all required inputs
            inputs.forEach(input => {
                if (!input.value.trim()) {
                    input.classList.add('is-invalid');
                    isValid = false;
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            });
            
            // Special validation for password confirmation
            if (currentStep === 2) {
                const password = document.getElementById('adminPassword');
                const confirmPassword = document.getElementById('adminPasswordConfirm');
                
                if (password.value.length < 6) {
                    password.classList.add('is-invalid');
                    isValid = false;
                } else {
                    password.classList.remove('is-invalid');
                    password.classList.add('is-valid');
                }
                
                if (password.value !== confirmPassword.value) {
                    confirmPassword.classList.add('is-invalid');
                    isValid = false;
                } else {
                    confirmPassword.classList.remove('is-invalid');
                    confirmPassword.classList.add('is-valid');
                }
            }
            
            // Email validation
            if (currentStep === 2) {
                const email = document.getElementById('adminEmail');
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                
                if (!emailRegex.test(email.value)) {
                    email.classList.add('is-invalid');
                    isValid = false;
                } else {
                    email.classList.remove('is-invalid');
                    email.classList.add('is-valid');
                }
            }
            
            // URL validation for Galaxy server
            if (currentStep === 1) {
                const galaxyServer = document.getElementById('galaxyServer');
                try {
                    new URL(galaxyServer.value);
                    galaxyServer.classList.remove('is-invalid');
                    galaxyServer.classList.add('is-valid');
                } catch {
                    galaxyServer.classList.add('is-invalid');
                    isValid = false;
                }
            }
            
            // Focus first invalid input
            if (!isValid) {
                const firstInvalid = currentStepElement.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
            }
            
            return isValid;
        }
        
        function finishSetup() {
            // Collect form data
            const formData = {
                serverHost: document.getElementById('serverHost').value,
                serverPort: document.getElementById('serverPort').value,
                maxUpload: document.getElementById('maxUpload').value,
                galaxyServer: document.getElementById('galaxyServer').value,
                galaxyApiKey: document.getElementById('galaxyApiKey').value,
                safeUpload: document.getElementById('safeUpload').checked,
                adminEmail: document.getElementById('adminEmail').value,
                adminPassword: document.getElementById('adminPassword').value
            };
            
            // Show loading state
            const submitButton = document.querySelector('.btn-success');
            const originalText = submitButton.innerHTML;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Installing...';
            submitButton.disabled = true;
            
            // Send data to server
            fetch('/api/setup', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success animation
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    // Show error
                    submitButton.innerHTML = originalText;
                    submitButton.disabled = false;
                    alert('Setup failed: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
                alert('Setup failed. Please try again.');
            });
        }
        
        // Add input event listeners for real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', function() {
                    if (this.classList.contains('is-invalid') || this.classList.contains('is-valid')) {
                        // Re-validate on input
                        validateCurrentStep();
                    }
                });
            });
        });
        
        // Initialize first step
        showStep(0);
        
        // Add keyboard navigation
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                nextStep();
            } else if (e.key === 'Enter' && e.shiftKey && currentStep > 0) {
                previousStep();
            }
        });
    </script>
</body>
</html>
